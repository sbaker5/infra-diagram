<%- include('layout', {
  title: 'Dashboard',
  page: 'dashboard',
  body: `
    <div class="page-header">
      <h1>Customers</h1>
      <div class="search-box">
        <input type="text" id="search" placeholder="Search customers..." value="${query || ''}">
        <a href="/customer/new" class="btn btn-primary">+ New Customer</a>
      </div>
    </div>

    ${customers.length === 0 ? `
      <div class="empty-state">
        <h3>No customers yet</h3>
        <p>Create your first customer to start building infrastructure diagrams.</p>
        <a href="/customer/new" class="btn btn-primary" style="margin-top: 1rem;">+ New Customer</a>
      </div>
    ` : `
      <div class="customer-grid">
        ${customers.map(customer => `
          <div class="customer-card">
            <a href="/customer/${customer.id}" class="customer-card-image">
              ${customer.png_path ? `
                <img src="/exports/${customer.png_path}" alt="${customer.name} diagram">
              ` : `
                <span class="no-diagram">No diagram yet</span>
              `}
            </a>
            <div class="customer-card-body">
              <h3 class="customer-card-title">
                <a href="/customer/${customer.id}" style="color: inherit; text-decoration: none;">
                  ${customer.name}
                </a>
                ${customer.is_unknown ? '<span class="badge badge-warning">Unknown</span>' : ''}
              </h3>
              <div class="customer-badges">
                ${customer.hasDiagram ? '<span class="type-badge type-diagram" title="Has infrastructure diagram">Diagram</span>' : ''}
                ${customer.hasNotes && !customer.hasDiagram ? '<span class="type-badge type-notes" title="Has meeting notes only">Notes</span>' : ''}
                ${customer.openActionItems > 0 ? `<span class="type-badge type-actions" title="${customer.openActionItems} open action items">${customer.openActionItems} tasks</span>` : ''}
              </div>
              <div class="customer-card-meta">
                ${customer.latest_version ? `Version ${customer.latest_version}` : 'No versions'}
                ${customer.latest_session_date ? ` Â· ${customer.latest_session_date}` : ''}
              </div>
              <div class="customer-card-actions">
                <a href="/customer/${customer.id}" class="btn btn-sm btn-outline">View</a>
                <button class="btn btn-sm btn-secondary" onclick="openEditModal(${customer.id}, \`${customer.name.replace(/`/g, '\\`')}\`)">Edit</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>

      <!-- Edit Customer Modal -->
      <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
          <h2 style="margin-bottom: 1.5rem;">Edit Customer</h2>
          <form id="editForm">
            <input type="hidden" id="editCustomerId">

            <div class="form-group">
              <label for="editName">Rename Customer</label>
              <input type="text" id="editName" class="form-control" placeholder="Enter new name">
            </div>

            <p style="text-align: center; color: #666; margin: 1rem 0;">- or merge with existing -</p>

            <div class="form-group">
              <label for="mergeCustomer">Merge Into</label>
              <select id="mergeCustomer" class="form-control">
                <option value="">Select customer to merge into...</option>
              </select>
              <small style="color: #666;">This will move all diagrams and notes to the selected customer</small>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
              <button type="button" class="btn btn-outline" style="flex: 1;" onclick="closeEditModal()">Cancel</button>
              <button type="submit" class="btn btn-primary" style="flex: 1;">Save</button>
            </div>
          </form>
        </div>
      </div>
    `}
  `,
  extraScripts: `
    <script>
      const searchInput = document.getElementById('search');
      let timeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          const query = searchInput.value;
          window.location.href = query ? '/?q=' + encodeURIComponent(query) : '/';
        }, 300);
      });

      // Edit Modal
      const editModal = document.getElementById('editModal');
      const editForm = document.getElementById('editForm');
      const editCustomerId = document.getElementById('editCustomerId');
      const editName = document.getElementById('editName');
      const mergeCustomer = document.getElementById('mergeCustomer');

      async function openEditModal(customerId, currentName) {
        editCustomerId.value = customerId;
        editName.value = currentName;
        mergeCustomer.value = '';

        // Load customers for merge dropdown
        try {
          const res = await fetch('/api/customers');
          const customers = await res.json();
          mergeCustomer.innerHTML = '<option value="">Select customer to merge into...</option>';
          customers
            .filter(c => c.id !== customerId)
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(c => {
              mergeCustomer.innerHTML += '<option value="' + c.id + '">' + c.name + '</option>';
            });
        } catch (e) {
          console.error('Failed to load customers:', e);
        }

        editModal.style.display = 'flex';
      }

      function closeEditModal() {
        editModal.style.display = 'none';
      }

      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const customerId = editCustomerId.value;
        const name = editName.value.trim();
        const mergeId = mergeCustomer.value;

        if (!name && !mergeId) {
          alert('Please enter a name or select a customer to merge into');
          return;
        }

        try {
          const res = await fetch('/customer/' + customerId + '/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: mergeId ? null : name,
              existing_customer_id: mergeId || null
            })
          });

          const data = await res.json();
          if (data.success) {
            window.location.reload();
          } else {
            alert('Failed: ' + data.error);
          }
        } catch (err) {
          alert('Failed: ' + err.message);
        }
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) closeEditModal();
      });
    </script>
  `
}) %>
