<%- include('layout', {
  title: customer.name,
  page: 'customer',
  body: `
    <div class="customer-header">
      <div class="customer-info">
        <h1>
          ${customer.name}
          ${customer.is_unknown ? '<span class="badge badge-warning">Unknown</span>' : ''}
        </h1>
        <p class="meta">
          ${versions.length} version${versions.length !== 1 ? 's' : ''}
          ${sessions.length > 0 ? ` · ${sessions.length} session${sessions.length !== 1 ? 's' : ''} processed` : ''}
        </p>
      </div>
      <div class="btn-group">
        <a href="/customer/${customer.id}/edit" class="btn btn-primary">Edit Diagram</a>
        ${currentVersion ? `<a href="/customer/${customer.id}/download${currentVersion.version ? '?v=' + currentVersion.version : ''}" class="btn btn-outline">Download PNG</a>` : ''}
        <button class="btn btn-danger" onclick="deleteCustomer()">Delete Customer</button>
      </div>
    </div>

    <div class="diagram-viewer">
      <div class="diagram-main">
        <div class="diagram-display">
          ${currentVersion && currentVersion.png_path ? `
            <img src="/exports/${currentVersion.png_path}" alt="${customer.name} infrastructure diagram">
          ` : `
            <div class="empty-state">
              <h3>No diagram yet</h3>
              <p>Create your first version by clicking "Edit Diagram"</p>
            </div>
          `}
        </div>
      </div>

      <div class="diagram-sidebar">
        <div class="card">
          <div class="card-header">
            <h2>Versions</h2>
          </div>
          <div class="card-body" style="padding: 0;">
            ${versions.length > 0 ? `
              <ul class="version-list">
                ${versions.map(v => `
                  <li class="version-item ${currentVersion && currentVersion.version === v.version ? 'active' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                      <div onclick="window.location.href='/customer/${customer.id}?v=${v.version}'" style="cursor: pointer; flex: 1;">
                        <div class="version-item-title">Version ${v.version}</div>
                        <div class="version-item-date">${new Date(v.created_at).toLocaleString()}</div>
                        ${v.notes ? `<div class="version-item-notes" style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">${v.notes}</div>` : ''}
                      </div>
                      <button class="btn-delete-version" onclick="event.stopPropagation(); deleteVersion(${v.version})" title="Delete version">×</button>
                    </div>
                  </li>
                `).join('')}
              </ul>
            ` : `
              <div style="padding: 1rem; color: #666; text-align: center;">
                No versions yet
              </div>
            `}
          </div>
        </div>

        ${sessions.length > 0 ? `
          <div class="card">
            <div class="card-header">
              <h2>Sessions</h2>
            </div>
            <div class="card-body">
              <ul class="sessions-list">
                ${sessions.map(s => `
                  <li>
                    <a href="${s.session_url}" target="_blank" style="color: var(--primary-color); text-decoration: none;">
                      ${s.session_url.split('/').pop().substring(0, 8)}...
                    </a>
                    <div style="font-size: 0.8rem; color: #666;">${new Date(s.processed_at).toLocaleDateString()}</div>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        ` : ''}
      </div>
    </div>

    ${actionItems && actionItems.length > 0 ? `
    <div class="action-items-section">
      <div class="section-header">
        <h2>Action Items <span class="open-count">${openActionItemCount} open</span></h2>
        <label class="show-completed-toggle">
          <input type="checkbox" id="show-completed" />
          Show completed
        </label>
      </div>

      <div class="action-items-container" id="action-items-list">
        ${['Stephen', 'Customer', 'Vendor', 'Unknown'].map(owner => {
          const ownerItems = actionItems.filter(i => i.owner === owner);
          if (ownerItems.length === 0) return '';
          const ownerClass = owner === 'Stephen' ? 'owner-stephen' : owner === 'Customer' ? 'owner-customer' : owner === 'Vendor' ? 'owner-vendor' : 'owner-unknown';
          return `
            <div class="owner-group ${ownerClass}">
              <h3 class="owner-title">${owner}</h3>
              <ul class="action-items-list">
                ${ownerItems.map(item => `
                  <li class="action-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
                    <label class="checkbox-label">
                      <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleActionItem(${item.id}, this)" />
                      <span class="item-text">${item.item}</span>
                    </label>
                    <span class="item-date">${item.session_date || ''}</span>
                    ${item.session_title ? `<span class="item-session">${item.session_title}</span>` : ''}
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    ` : ''}

    ${sessionNotes && sessionNotes.length > 0 ? `
    <div class="session-notes-section">
      <h2>Meeting Notes</h2>
      ${sessionNotes.map(note => `
        <div class="session-note-card">
          <div class="note-header">
            <span class="badge ${note.call_type === 'technical' ? 'badge-success' : 'badge-info'}">
              ${note.call_type === 'technical' ? 'Technical' : 'Non-Technical'}
            </span>
            <span class="note-title">${note.title || 'Session'}</span>
            <span class="note-date">${new Date(note.processed_at).toLocaleDateString()}</span>
          </div>

          ${note.summary ? `
          <div class="note-summary">
            <p>${note.summary}</p>
          </div>
          ` : ''}

          ${note.call_type === 'technical' && note.gaps && note.gaps.length > 0 ? `
          <div class="note-gaps">
            <h4>Infrastructure Gaps</h4>
            <ul class="gaps-list">
              ${note.gaps.map(g => `<li>${g.category}: ${g.component}</li>`).join('')}
            </ul>
          </div>
          ` : ''}
        </div>
      `).join('')}
    </div>
    ` : ''}
  `,
  extraScripts: `
    <style>
      .action-items-section {
        margin-top: 2rem;
        background: #fff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .section-header h2 {
        margin: 0;
        font-size: 1.25rem;
      }

      .open-count {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: normal;
        margin-left: 0.5rem;
      }

      .show-completed-toggle {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        cursor: pointer;
        color: #6b7280;
        font-size: 0.85rem;
      }

      .action-items-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .owner-group {
        padding: 1rem;
        border-radius: 8px;
      }

      .owner-group.owner-stephen { background: #eff6ff; }
      .owner-group.owner-customer { background: #fefce8; }
      .owner-group.owner-vendor { background: #f0f5ff; }
      .owner-group.owner-unknown { background: #f3f4f6; }

      .owner-title {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
      }

      .action-items-section .action-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .action-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(255,255,255,0.7);
        border-radius: 4px;
      }

      .action-item.completed {
        display: none;
      }

      .action-items-container.show-completed .action-item.completed {
        display: flex;
        opacity: 0.6;
      }

      .action-item.completed .item-text {
        text-decoration: line-through;
        color: #9ca3af;
      }

      .checkbox-label {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        cursor: pointer;
        flex: 1;
      }

      .checkbox-label input {
        margin-top: 0.2rem;
        cursor: pointer;
      }

      .item-text {
        flex: 1;
        line-height: 1.4;
      }

      .item-date {
        font-size: 0.75rem;
        color: #9ca3af;
        white-space: nowrap;
      }

      .item-session {
        font-size: 0.75rem;
        color: #6b7280;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
    <script>
      // Action items toggle
      async function toggleActionItem(id, checkbox) {
        try {
          const response = await fetch('/api/action-items/' + id + '/toggle', { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            const li = checkbox.closest('.action-item');
            if (data.completed) {
              li.classList.add('completed');
            } else {
              li.classList.remove('completed');
            }
            // Update open count
            const countEl = document.querySelector('.open-count');
            if (countEl) {
              const currentCount = parseInt(countEl.textContent) || 0;
              const newCount = data.completed ? currentCount - 1 : currentCount + 1;
              countEl.textContent = newCount + ' open';
            }
          } else {
            alert('Failed to update: ' + data.error);
            checkbox.checked = !checkbox.checked;
          }
        } catch (error) {
          alert('Failed to update: ' + error.message);
          checkbox.checked = !checkbox.checked;
        }
      }

      // Show completed toggle
      document.addEventListener('DOMContentLoaded', function() {
        const showCompletedCheckbox = document.getElementById('show-completed');
        const container = document.getElementById('action-items-list');
        if (showCompletedCheckbox && container) {
          showCompletedCheckbox.addEventListener('change', function() {
            if (this.checked) {
              container.classList.add('show-completed');
            } else {
              container.classList.remove('show-completed');
            }
          });
        }
      });

      async function deleteCustomer() {
        if (!confirm('Delete "${customer.name}" and all diagram versions? This cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch('/customer/${customer.id}/delete', { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            window.location.href = data.redirect || '/';
          } else {
            alert('Failed to delete: ' + data.error);
          }
        } catch (error) {
          alert('Failed to delete: ' + error.message);
        }
      }

      async function deleteVersion(version) {
        if (!confirm('Delete version ' + version + '? This cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch('/customer/${customer.id}/version/' + version + '/delete', { method: 'POST' });
          const data = await response.json();
          if (data.success) {
            window.location.reload();
          } else {
            alert('Failed to delete: ' + data.error);
          }
        } catch (error) {
          alert('Failed to delete: ' + error.message);
        }
      }
    </script>
  `
}) %>
